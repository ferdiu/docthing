#!/usr/bin/env bash

set -e

if [ -d ".git" ] && [ ! -e ".git/hooks/pre-commit" ]; then
    ln -s ../../bin/pre-commit .git/hooks/"$(basename $0)"
fi

echo "#################################"
echo "##                             ##"
echo "##   RUNNING PRE-COMMIT HOOK   ##"
echo "##                             ##"
echo "#################################"
echo

echo "1. Enforcing style \`autopep8 --in-place --aggressive --aggressive \"*.py\"\`"
autopep8 --in-place --aggressive --aggressive $(find . -name "*.py")
echo

echo "2. Checking for syntax errors \`flake8 . --select=E9,F63,F7,F82 --show-source --statistics\`"
flake8 . --select=E9,F63,F7,F82 --show-source --statistics
echo

echo "3. Exit with error if flake8 fails \`flake8 . --max-complexity=10 --max-line-length=127 --statistics\`"
flake8 . --max-complexity=10 --max-line-length=127 --statistics
echo

echo "4. Running tests \`pytest\`"
pytest
echo

# TODO: increase required coverate to al least 90
echo "5. Running coverage \`pytest-cov\`"
pytest --cov src --cov-fail-under 25
echo

echo "6. The pre-commit hook has finished successfully!"
echo "Bye ;)"
echo
